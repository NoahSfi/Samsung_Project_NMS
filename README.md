# OptimiseNMS

OptimiseNMS is a project aiming at finding the optimal intersection of union (IoU) threshold to use inside the non max suppression alogirthm for object detections (OD) for a given class of object. Indeed every class has a different overlaping behavior. Hence to have a better average precision (AP) when evaluating a model on a given class one should give an adapted IoU treshold. 
Also the project allows to compute an IoU treshold for an overall set of classes.

This IoU treshold being a hyperparameter of the OD model, one can't evaluate it on the training data set. That is why we evaluate a validation dataset. But sometime for some classes the number of images is insufficent and the results are not precise enough.

That is why it gives two ways of computing it. Before explaining this ways let us define some variables.

```math
We define the Miss Rate (MR) to be #FN/#instances. Hence we have 3 different type of MR:

- MR_err is the one genreated by the model
- MR_nms_validation the one generated by the nms on the validation dataset
- MR_nms_train the one generated by the nms on the training dataset

We finally have that:

MR = MR_err + MR_nms


Hence we can play on this MR_nms and take the one of the training data set to have more precisions. Both results can be computed using this project.
```

The project allows to compare different models, plot the precision to recall for each iou and each specified classes. It also allows to observe via multiple plot the overlapping behavior of each classes. 

## Installation

In order to run correctly the analysis one need to have:

* An annotation file for the validation dataset in the coco format.
* A folder containing all the images of the validation dataset
* If one wants to use MR_nms_train, an annotation file for the training dataset in the cocoformat.
* A folder containing a tensorflow OD model. Please visit [Tensorflow detection model zoo](https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/detection_model_zoo.md).

**Caution**: All the results will be written in the relative path.

* Copy the project and the use 3 classes as follow.

## Usage

```python
from nmsAnalysis import nmsAnalysis
from groundTruthFN import GroundTruthFN
from optimised_nms import optimisedNMS

"""Here is a complete example of use if one only wants to deal with the validation data set"""
    # If catFocus = None then it takes all the categories inside the annotation file of the validation dataset. 
    # Else one can specify like this catFocus = ["person","bicycle"]. 
    # models is a list of path to the OD models.
    # annotationValidation is the path to the annotation file of the validation dataset.
    # imagesPath is the path to the images.
    # overall is a boolean deciding if it computes the AP to IoU for the overall.
    analyser = nmsAnalysis(models,imagesPath,annotationValidation,catFocus,number_IoU_thresh,overall)
    analyser.with_train = False
    analyser.runAnalysis() #Compute AP to IoU with MR_nms_validation for each catFocus
    optimiser = optimisedNMS(models,None,annotationValidation,catFocus=catFocus)
    optimiser.with_train = False
    optimiser.compare_model()
    optimiser.writeMapIoU()
    # If overall = True
    for model in models:
        optimiser.overallArgmax(model)
        ptimiser.plotOverall()

"""Here is a complete example of use with MR_nms_train"""
    fn_validation = GroundTruthFN(annotationValidation,dataType="validation",catFocus=catFocus)
    fn_validation.runAnalysis()
    fn_train = GroundTruthFN(annotationTrain,dataType="train",catFocus=catFocus)
    fn_train.runAnalysis()
    analyser = nmsAnalysis(models,imagesPath,annotationValidation,catFocus,number_IoU_thresh,overall)
    analyser.with_train = True
    analyser.runAnalysis()
    optimiser = optimisedNMS(models,None,annotationValidation,catFocus=catFocus)
    optimiser.with_train = True
    optimiser.compare_model()
    optimiser.writeMapIoU()
    for model in models:
        optimiser.overallArgmax(model)
    # If overall = True
    optimiser.plotOverall()
```

All the results for a given model will be written inside the model path in the folder __nms_analysis__. If one use the function `optimiser.compare_model()` a folder __model_comparison__ will be written inside the relative path. 

The final result of each category will be written with `optimiser.writeMapIoU()` in **nms_analysis/iouThreshmap.pbtxt**. And the overall inside the folder **nms_analysis/optimal_overall**.

When running a model, it will create a file **all_output_dict.json** it is a dictionnary containing all detections made by the model. It allows faster computation for other analysis with the same model.


## Contributing

